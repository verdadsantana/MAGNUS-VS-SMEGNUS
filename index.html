<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>MAGNUS VS SMEGNUS</title>

<style>
body{
 margin:0;
 background:#000;
 color:#fff;
 font-family:Arial;
 overflow:hidden;
 display:flex;
 align-items:center;
 justify-content:center;
 height:100vh;
}

#menu{text-align:center}
button,input{padding:14px;font-size:18px;margin:10px;border:none;border-radius:10px}

canvas{
 background:linear-gradient(#12002a,#000);
 image-rendering:pixelated;
}

/* joystick */
#stick{
 position:absolute;
 left:30px;
 bottom:60px;
 width:140px;
 height:140px;
 border-radius:50%;
 background:#ffffff22;
}

#knob{
 position:absolute;
 left:30px;
 bottom:60px;
 width:140px;
 height:140px;
 display:flex;
 align-items:center;
 justify-content:center;
 pointer-events:none;
}
#knob div{
 width:60px;height:60px;border-radius:50%;
 background:#fff4;
}

/* buttons */
.ctrl{
 position:absolute;
 width:70px;height:70px;
 border-radius:50%;
 background:#ffffff22;
 color:white;
 font-size:24px;
 display:flex;
 align-items:center;
 justify-content:center;
}

#punch{right:30px;bottom:160px}
#block{right:110px;bottom:80px}
#shoot{right:30px;bottom:80px}

</style>
</head>
<body>

<div id="menu">
<h1>MAGNUS VS SMEGNUS</h1>
<button onclick="createRoom()">CREA PARTITA</button><br>
<input id="codeInput" placeholder="CODICE"><br>
<button onclick="joinRoom()">ENTRA</button>
<p id="roomCode"></p>
</div>

<canvas id="game" width="900" height="420" style="display:none"></canvas>

<div id="stick"></div>
<div id="knob"><div id="knobInner"></div></div>

<div id="punch" class="ctrl">ðŸ‘Š</div>
<div id="block" class="ctrl">ðŸ›¡</div>
<div id="shoot" class="ctrl">âš¡</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>

// ---------------- ASSETS ----------------
const magnusImg=new Image();
const smegnusImg=new Image();

magnusImg.src="magnus.png";
smegnusImg.src="smegnus.png";

magnusImg.onerror=()=>alert("magnus.png mancante");
smegnusImg.onerror=()=>alert("smegnus.png mancante");

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

// ---------------- MULTIPLAYER ----------------
let peer,conn;

function createRoom(){
 const code=Math.random().toString(36).substring(2,8).toUpperCase();
 document.getElementById("roomCode").textContent=code;

 peer=new Peer(code);

 peer.on("connection",c=>{
  conn=c;
  startGame(true);
 });
}

function joinRoom(){
 const code=document.getElementById("codeInput").value.trim().toUpperCase();
 if(!code)return alert("Inserisci codice");

 peer=new Peer();

 peer.on("open",()=>{
  conn=peer.connect(code);
  conn.on("open",()=>startGame(false));
 });
}

// ---------------- GAME ----------------
const FLOOR=240;
let me,enemy,bullets=[];
let input={};

function makePlayer(x,f){
 return {x,y:FLOOR,vy:0,hp:100,face:f,block:false};
}

function startGame(host){
 document.getElementById("menu").style.display="none";
 canvas.style.display="block";

 me=makePlayer(host?150:650,host?1:-1);
 enemy=makePlayer(host?650:150,host?-1:1);

 loop();
}

// ---------------- JOYSTICK ----------------
const stick=document.getElementById("stick");
const knob=document.getElementById("knobInner");

let dragging=false;
let origin=null;

stick.addEventListener("touchstart",e=>{
 dragging=true;
 const r=stick.getBoundingClientRect();
 origin={x:r.left+r.width/2,y:r.top+r.height/2};
 e.preventDefault();
},{passive:false});

window.addEventListener("touchend",()=>{
 dragging=false;
 knob.style.transform="translate(0,0)";
 input.left=input.right=false;
});

window.addEventListener("touchmove",e=>{
 if(!dragging)return;

 const t=[...e.touches].find(t=>t.target===stick)||e.touches[0];

 let dx=t.clientX-origin.x;
 let dy=t.clientY-origin.y;

 const max=45;
 const dist=Math.min(Math.hypot(dx,dy),max);
 const ang=Math.atan2(dy,dx);

 dx=Math.cos(ang)*dist;
 dy=Math.sin(ang)*dist;

 knob.style.transform=`translate(${dx}px,${dy}px)`;

 input.left=dx<-10;
 input.right=dx>10;

 e.preventDefault();
},{passive:false});

// ---------------- BUTTONS ----------------
["punch","block","shoot"].forEach(id=>{
 const el=document.getElementById(id);
 el.ontouchstart=e=>{input[id]=true;e.preventDefault();}
 el.ontouchend=e=>{input[id]=false;e.preventDefault();}
});

// ---------------- LOGIC ----------------
function update(){

 if(input.left){me.x-=4;me.face=-1}
 if(input.right){me.x+=4;me.face=1}

 me.block=input.block;

 // punch
 if(input.punch&&!me.cool){
  if(Math.abs(me.x-enemy.x)<130&&!enemy.block){
   enemy.hp-=10;
   enemy.x+=me.face*25;
  }
  me.cool=20;
 }

 // shoot
 if(input.shoot&&!me.cool){
  bullets.push({x:me.x+70,y:me.y+70,vx:me.face*9});
  me.cool=30;
 }

 if(me.cool)me.cool--;

 for(let b of bullets){
  b.x+=b.vx;
  if(Math.abs(b.x-enemy.x)<80&&!enemy.block){
   enemy.hp-=12;
   b.dead=true;
  }
 }
 bullets=bullets.filter(b=>!b.dead);

 // sync
 if(conn && conn.open){
  conn.send({me,bullets});
  conn.on("data",d=>{
   enemy=d.me;
  });
 }
}

// ---------------- DRAW ----------------
function drawPlayer(p,img){
 ctx.save();

 if(p.face==-1){
  ctx.translate(p.x+150,0);
  ctx.scale(-1,1);
  ctx.drawImage(img,0,p.y,150,180);
 }else{
  ctx.drawImage(img,p.x,p.y,150,180);
 }

 ctx.restore();
}

function draw(){

 ctx.clearRect(0,0,900,420);

 ctx.fillStyle="#2a0044";
 ctx.fillRect(0,380,900,40);

 drawPlayer(me,magnusImg);
 drawPlayer(enemy,smegnusImg);

 for(let b of bullets){
  ctx.fillStyle="orange";
  ctx.beginPath();
  ctx.arc(b.x,b.y,12,0,6.28);
  ctx.fill();
 }

 // hp bars
 ctx.fillStyle="red";
 ctx.fillRect(30,30,me.hp*3,20);
 ctx.fillRect(870-enemy.hp*3,30,enemy.hp*3,20);
}

// ---------------- LOOP ----------------
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
</script>
</body>
</html><!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>MAGNUS VS SMEGNUS</title>

<style>
body{
 margin:0;
 background:#000;
 color:#fff;
 font-family:Arial;
 overflow:hidden;
 display:flex;
 align-items:center;
 justify-content:center;
 height:100vh;
}

#menu{text-align:center}
button,input{padding:14px;font-size:18px;margin:10px;border:none;border-radius:10px}

canvas{
 background:linear-gradient(#12002a,#000);
 image-rendering:pixelated;
}

/* joystick */
#stick{
 position:absolute;
 left:30px;
 bottom:60px;
 width:140px;
 height:140px;
 border-radius:50%;
 background:#ffffff22;
}

#knob{
 position:absolute;
 left:30px;
 bottom:60px;
 width:140px;
 height:140px;
 display:flex;
 align-items:center;
 justify-content:center;
 pointer-events:none;
}
#knob div{
 width:60px;height:60px;border-radius:50%;
 background:#fff4;
}

/* buttons */
.ctrl{
 position:absolute;
 width:70px;height:70px;
 border-radius:50%;
 background:#ffffff22;
 color:white;
 font-size:24px;
 display:flex;
 align-items:center;
 justify-content:center;
}

#punch{right:30px;bottom:160px}
#block{right:110px;bottom:80px}
#shoot{right:30px;bottom:80px}

</style>
</head>
<body>

<div id="menu">
<h1>MAGNUS VS SMEGNUS</h1>
<button onclick="createRoom()">CREA PARTITA</button><br>
<input id="codeInput" placeholder="CODICE"><br>
<button onclick="joinRoom()">ENTRA</button>
<p id="roomCode"></p>
</div>

<canvas id="game" width="900" height="420" style="display:none"></canvas>

<div id="stick"></div>
<div id="knob"><div id="knobInner"></div></div>

<div id="punch" class="ctrl">ðŸ‘Š</div>
<div id="block" class="ctrl">ðŸ›¡</div>
<div id="shoot" class="ctrl">âš¡</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>

// ---------------- ASSETS ----------------
const magnusImg=new Image();
const smegnusImg=new Image();

magnusImg.src="magnus.png";
smegnusImg.src="smegnus.png";

magnusImg.onerror=()=>alert("magnus.png mancante");
smegnusImg.onerror=()=>alert("smegnus.png mancante");

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

// ---------------- MULTIPLAYER ----------------
let peer,conn;

function createRoom(){
 const code=Math.random().toString(36).substring(2,8).toUpperCase();
 document.getElementById("roomCode").textContent=code;

 peer=new Peer(code);

 peer.on("connection",c=>{
  conn=c;
  startGame(true);
 });
}

function joinRoom(){
 const code=document.getElementById("codeInput").value.trim().toUpperCase();
 if(!code)return alert("Inserisci codice");

 peer=new Peer();

 peer.on("open",()=>{
  conn=peer.connect(code);
  conn.on("open",()=>startGame(false));
 });
}

// ---------------- GAME ----------------
const FLOOR=240;
let me,enemy,bullets=[];
let input={};

function makePlayer(x,f){
 return {x,y:FLOOR,vy:0,hp:100,face:f,block:false};
}

function startGame(host){
 document.getElementById("menu").style.display="none";
 canvas.style.display="block";

 me=makePlayer(host?150:650,host?1:-1);
 enemy=makePlayer(host?650:150,host?-1:1);

 loop();
}

// ---------------- JOYSTICK ----------------
const stick=document.getElementById("stick");
const knob=document.getElementById("knobInner");

let dragging=false;
let origin=null;

stick.addEventListener("touchstart",e=>{
 dragging=true;
 const r=stick.getBoundingClientRect();
 origin={x:r.left+r.width/2,y:r.top+r.height/2};
 e.preventDefault();
},{passive:false});

window.addEventListener("touchend",()=>{
 dragging=false;
 knob.style.transform="translate(0,0)";
 input.left=input.right=false;
});

window.addEventListener("touchmove",e=>{
 if(!dragging)return;

 const t=[...e.touches].find(t=>t.target===stick)||e.touches[0];

 let dx=t.clientX-origin.x;
 let dy=t.clientY-origin.y;

 const max=45;
 const dist=Math.min(Math.hypot(dx,dy),max);
 const ang=Math.atan2(dy,dx);

 dx=Math.cos(ang)*dist;
 dy=Math.sin(ang)*dist;

 knob.style.transform=`translate(${dx}px,${dy}px)`;

 input.left=dx<-10;
 input.right=dx>10;

 e.preventDefault();
},{passive:false});

// ---------------- BUTTONS ----------------
["punch","block","shoot"].forEach(id=>{
 const el=document.getElementById(id);
 el.ontouchstart=e=>{input[id]=true;e.preventDefault();}
 el.ontouchend=e=>{input[id]=false;e.preventDefault();}
});

// ---------------- LOGIC ----------------
function update(){

 if(input.left){me.x-=4;me.face=-1}
 if(input.right){me.x+=4;me.face=1}

 me.block=input.block;

 // punch
 if(input.punch&&!me.cool){
  if(Math.abs(me.x-enemy.x)<130&&!enemy.block){
   enemy.hp-=10;
   enemy.x+=me.face*25;
  }
  me.cool=20;
 }

 // shoot
 if(input.shoot&&!me.cool){
  bullets.push({x:me.x+70,y:me.y+70,vx:me.face*9});
  me.cool=30;
 }

 if(me.cool)me.cool--;

 for(let b of bullets){
  b.x+=b.vx;
  if(Math.abs(b.x-enemy.x)<80&&!enemy.block){
   enemy.hp-=12;
   b.dead=true;
  }
 }
 bullets=bullets.filter(b=>!b.dead);

 // sync
 if(conn && conn.open){
  conn.send({me,bullets});
  conn.on("data",d=>{
   enemy=d.me;
  });
 }
}

// ---------------- DRAW ----------------
function drawPlayer(p,img){
 ctx.save();

 if(p.face==-1){
  ctx.translate(p.x+150,0);
  ctx.scale(-1,1);
  ctx.drawImage(img,0,p.y,150,180);
 }else{
  ctx.drawImage(img,p.x,p.y,150,180);
 }

 ctx.restore();
}

function draw(){

 ctx.clearRect(0,0,900,420);

 ctx.fillStyle="#2a0044";
 ctx.fillRect(0,380,900,40);

 drawPlayer(me,magnusImg);
 drawPlayer(enemy,smegnusImg);

 for(let b of bullets){
  ctx.fillStyle="orange";
  ctx.beginPath();
  ctx.arc(b.x,b.y,12,0,6.28);
  ctx.fill();
 }

 // hp bars
 ctx.fillStyle="red";
 ctx.fillRect(30,30,me.hp*3,20);
 ctx.fillRect(870-enemy.hp*3,30,enemy.hp*3,20);
}

// ---------------- LOOP ----------------
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
</script>
</body>
</html>
