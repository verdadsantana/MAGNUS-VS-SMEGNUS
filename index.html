<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<style>
body{margin:0;background:black;color:white;font-family:monospace;text-align:center}
canvas{background:linear-gradient(#12002a,#000);image-rendering:pixelated}

button,input{
 padding:15px;
 font-size:18px;
 margin:10px;
 border:none;
 border-radius:10px;
}

/* joystick */
#stick{
 position:absolute;
 left:40px;
 bottom:80px;
 width:140px;
 height:140px;
 border-radius:50%;
 background:#ffffff22;
}

#knob{
 position:absolute;
 left:40px;
 bottom:80px;
 width:140px;
 height:140px;
 pointer-events:none;
 display:flex;
 align-items:center;
 justify-content:center;
}

#knob div{
 width:60px;
 height:60px;
 border-radius:50%;
 background:#fff4;
}

/* buttons */
.ctrl{
 position:absolute;
 width:70px;height:70px;
 border-radius:50%;
 background:#ffffff22;
 color:white;
 font-size:25px;
 border:none;
}

#punch{right:30px;bottom:170px}
#block{right:110px;bottom:80px}
#shoot{right:30px;bottom:80px}

</style>
</head>
<body>

<div id="menu">
<h1>MAGNUS VS SMEGNUS</h1>
<button onclick="createRoom()">CREA PARTITA</button><br>
<input id="codeInput" placeholder="CODICE"><br>
<button onclick="joinRoom()">ENTRA</button>
<p id="roomCode"></p>
</div>

<canvas id="game" width="900" height="420" style="display:none"></canvas>

<div id="stick"></div>
<div id="knob"><div></div></div>

<button id="punch" class="ctrl">ðŸ‘Š</button>
<button id="block" class="ctrl">ðŸ›¡</button>
<button id="shoot" class="ctrl">âš¡</button>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>

// ---------------- MULTIPLAYER ----------------

let peer,conn;

function createRoom(){
 const code=Math.random().toString(36).substring(2,8).toUpperCase();
 document.getElementById("roomCode").textContent="Codice: "+code;

 peer=new Peer(code);

 peer.on("connection",c=>{
  conn=c;
  startGame(true);
 });
}

function joinRoom(){
 const code=document.getElementById("codeInput").value.trim().toUpperCase();
 if(!code)return alert("Inserisci codice");

 peer=new Peer();

 peer.on("open",()=>{
  conn=peer.connect(code);
  conn.on("open",()=>startGame(false));
 });
}

// ---------------- GAME ----------------

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

const magnusImg=new Image();
magnusImg.src="magnus.png";

const smegnusImg=new Image();
smegnusImg.src="smegnus.png";

let me,enemy,bullets=[];
let input={};

function startGame(host){

 document.getElementById("menu").style.display="none";
 canvas.style.display="block";

 if(host){
  me={x:150,y:240,hp:100,face:1};
  enemy={x:650,y:240,hp:100,face:-1};
 }else{
  me={x:650,y:240,hp:100,face:-1};
  enemy={x:150,y:240,hp:100,face:1};
 }

 loop();
}

// ---------------- JOYSTICK ----------------

const stick=document.getElementById("stick");
const knob=document.getElementById("knob").firstChild;

let dragging=false;

stick.addEventListener("touchstart",()=>dragging=true);

window.addEventListener("touchend",()=>{
 dragging=false;
 knob.style.transform="translate(0px,0px)";
 input.left=false;
 input.right=false;
});

window.addEventListener("touchmove",e=>{
 if(!dragging)return;

 const rect=stick.getBoundingClientRect();
 const t=e.touches[0];

 let x=t.clientX-(rect.left+rect.width/2);

 const max=40;
 x=Math.max(-max,Math.min(max,x));

 knob.style.transform=`translate(${x}px,0px)`;

 input.left=x<-10;
 input.right=x>10;
});

// ---------------- BUTTONS ----------------

punch.ontouchstart=()=>input.punch=true;
punch.ontouchend=()=>input.punch=false;

block.ontouchstart=()=>input.block=true;
block.ontouchend=()=>input.block=false;

shoot.ontouchstart=()=>input.shoot=true;
shoot.ontouchend=()=>input.shoot=false;

// ---------------- MECHANICS ----------------

function update(){

 if(input.left){me.x-=4;me.face=-1}
 if(input.right){me.x+=4;me.face=1}

 me.block=input.block;

 if(input.punch && !me.cool){
  if(Math.abs(me.x-enemy.x)<120 && !enemy.block){
   enemy.hp-=8;
   enemy.x+=me.face*20;
  }
  me.cool=20;
 }

 if(input.shoot && !me.cool){
  bullets.push({x:me.x+70,y:me.y+70,vx:me.face*8});
  me.cool=30;
 }

 if(me.cool)me.cool--;

 for(let b of bullets){
  b.x+=b.vx;
  if(Math.abs(b.x-enemy.x)<80 && !enemy.block){
   enemy.hp-=10;
   b.dead=true;
  }
 }

 bullets=bullets.filter(b=>!b.dead);

 if(conn){
  conn.send({me,bullets});
  conn.on("data",d=>{
   enemy=d.me;
  });
 }
}

// ---------------- DRAW ----------------

function bar(x,y,h){
 ctx.fillStyle="#400";ctx.fillRect(x,y,300,20);
 ctx.fillStyle="#f00";ctx.fillRect(x,y,300*(h/100),20);
 ctx.strokeStyle="white";ctx.strokeRect(x,y,300,20);
}

function drawPlayer(p,img){
 ctx.save();
 if(p.face===-1){
  ctx.translate(p.x+150,0);
  ctx.scale(-1,1);
  ctx.drawImage(img,0,p.y,150,180);
 }else{
  ctx.drawImage(img,p.x,p.y,150,180);
 }
 ctx.restore();

 if(p.block){
  ctx.strokeStyle="cyan";
  ctx.strokeRect(p.x+40,p.y+40,60,80);
 }
}

function draw(){

 ctx.clearRect(0,0,900,420);

 bar(30,30,me.hp);
 bar(570,30,enemy.hp);

 ctx.fillStyle="#2a0044";
 ctx.fillRect(0,380,900,40);

 drawPlayer(me,magnusImg);
 drawPlayer(enemy,smegnusImg);

 for(let b of bullets){
  ctx.fillStyle="orange";
  ctx.beginPath();
  ctx.arc(b.x,b.y,12,0,6.28);
  ctx.fill();
 }
}

// ---------------- LOOP ----------------

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}

</script>
</body>
</html>
